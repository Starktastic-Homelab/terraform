name: Drift detection

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  check:
    name: Check for drift
    runs-on: self-hosted
    timeout-minutes: 15
    container:
      image: hashicorp/terraform:latest
    env:
      PM_API_URL: ${{ secrets.PM_API_URL }}
      PM_API_TOKEN_ID: ${{ secrets.PM_API_TOKEN_ID }}
      PM_API_TOKEN_SECRET: ${{ secrets.PM_API_TOKEN_SECRET }}
      AWS_ACCESS_KEY_ID: ${{ secrets.MINIO_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.MINIO_SECRET_KEY }}
      AWS_ENDPOINT_URL: ${{ secrets.MINIO_ENDPOINT }}
    outputs:
      drift_detected: ${{ steps.plan.outputs.drift }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Read manifest file
        run: |
          echo 'manifest<<EOF' >> $GITHUB_ENV
          cat packer-manifest.json >> $GITHUB_ENV
          echo -e '\nEOF' >> $GITHUB_ENV

      - name: Init
        run: terraform init

      - name: Check for drift
        id: plan
        env:
          TF_VAR_ssh_pub_key: ${{ vars.TF_VAR_SSH_PUB_KEY }}
          TF_VAR_base_vm_name: ${{ fromJSON(env.manifest).builds[0].custom_data.vm_name }}
        run: |
          set +e
          # -detailed-exitcode: 0=Succeeded, 1=Error, 2=Succeeded with diff (drift)
          terraform plan -detailed-exitcode -no-color > drift.log
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 2 ]; then
            echo "‚ö†Ô∏è Drift detected!"
            echo "drift=true" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ No drift."
            echo "drift=false" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Terraform error"
            exit 1
          fi

          base64 drift.log > drift.log.b64

      - name: Publish job summary
        if: always()
        run: |
          echo "### üåç Terraform Status" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.plan.outputs.drift }}" == "true" ]; then
             echo "‚ö†Ô∏è **Drift detected**" >> $GITHUB_STEP_SUMMARY
          else
             echo "‚úÖ **Infrastructure matches configuration**" >> $GITHUB_STEP_SUMMARY
          fi

          echo '' >> $GITHUB_STEP_SUMMARY
          echo '<details><summary>Show Plan Output</summary>' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '```HCL' >> $GITHUB_STEP_SUMMARY
          cat drift.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo '</details>' >> $GITHUB_STEP_SUMMARY

      - name: Upload drift log
        if: steps.plan.outputs.drift == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: drift-log
          path: drift.log.b64
          retention-days: 1

  report:
    name: Handle drift issue
    needs: check
    if: always() && needs.check.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download log
        if: needs.check.outputs.drift_detected == 'true'
        uses: actions/download-artifact@v7
        with:
          name: drift-log

      - name: Decode drift log
        if: needs.check.outputs.drift_detected == 'true'
        run: |
          base64 -d drift.log.b64 > drift.log
          DRIFT=$(cat drift.log)
          echo "DRIFT<<EOF" >> $GITHUB_ENV
          echo "$DRIFT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create issue
        env:
          DRIFT_DETECTED: ${{ needs.check.outputs.drift_detected }}
          GH_TOKEN: ${{ github.token }}
        run: |
          gh label create "drift" --color "d73a4a" --description "Infrastructure drift detected" || true
          EXISTING_ISSUE=$(gh issue list --state open --label "drift" --json number --jq '.[0].number')

          if [ "$DRIFT_DETECTED" == "true" ]; then
            if [ -z "$EXISTING_ISSUE" ]; then
              gh issue create \
                --title "‚ö†Ô∏è Terraform drift detected: $(date +'%Y-%m-%d')" \
                --body "Infrastructure drift was detected during the scheduled check.

                <details><summary>Plan Output</summary>

                \`\`\`HCL
                ${{ env.DRIFT }}
                \`\`\`

                </details>

                Please review and either:
                1. Apply the changes (if the drift is valid updates made externally).
                2. Revert the external changes (if this was accidental).
                " \
                --label 'drift'
            else
              echo "Drift issue #$EXISTING_ISSUE already exists. Updating..."
              gh issue comment "$EXISTING_ISSUE" --body "‚ö†Ô∏è **Drift persists** as of $(date +'%Y-%m-%d'). See latest run artifacts."
            fi
          else
            if [ -n "$EXISTING_ISSUE" ]; then
              echo "Drift resolved. Closing issue #$EXISTING_ISSUE..."
              gh issue comment "$EXISTING_ISSUE" --body "‚úÖ **Resolved:** No drift detected in the latest run. Closing issue."
              gh issue close "$EXISTING_ISSUE"
            else
              echo "System clean and no open issues. Nothing to do."
            fi
          fi
